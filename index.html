<html>
<head>
  <title>UK TIMES Codes &amp; Acronyms</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta charset="utf-8">
  <script src="https://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
  <script src="d3.min.js"></script>
  <script src="lunr.min.js"></script>
  <style>
    body {
      margin: 50px;
      font: sans-serif;
    }
    table {
      width: 100%;
    }
    .record { 
      width: 100%;
    }
    input {
      margin: 0;
    }
    tr:nth-child(even) {
      background-color: #afa;
    }
    th { text-align: left; }
    td { vertical-align: top; }
    textarea { width: 100%; height: 5em; }
    .signedout #newrecord {
      display: none;
    }
    .signedin #signinmessage {
      display: none;
    }
    .signedout #signoutmessage {
      display: none;
    }
    .signedout td.control {
      display: none;
    }

    #filter {
      font-size: 150%;
      padding: 10px;
      width: 75%;
    }

    .filter .record {
      display: none;
    }

    .filter .record.show {
      display: table-row;
    }

    #showall {
      display: none;
    }

    .filter #showall {
      display: inline;
    }
      

  </style>
  </head>
  <body class='signedout'>
  <h1>UK TIMES Codes &amp; Acronyms</h1>
  <p>This is a (partial) list of codes and acronyms used in the UK version of the TIMES energy model.
  <span id='signinmessage'>Please <a href='/' id='signin'>sign in</a> to edit or add acronyms.</span>
  <span id='signoutmessage'>You are signed in, so you can add or edit acronyms. <a href='/' id='signout'>Sign out</a>.</span>
  </p>

  <p><input type='text' id='filter' placeholder='search'>&nbsp;<a href='/' id='showall'>show all</a></p>

  <table id='acronyms'>
    <thead>
    <tr id='headings'>
      <th class='acronym'>Acronym</th>
      <th class='alias'>Aliases</th>
      <th class='description'>Description</th>
      <th></th>
    </tr>
  </thead>
  <tbody>

  </tbody>
  <tfoot>
    <tr class='record' id='newrecord'>
      <td class='acronym'><input class="" type="text" id="acronymInput" placeholder="The acronym"></td>
      <td class='alias'><input class="" type="text" id="aliasInput" placeholder="Other acronyms for the same thing"></td>
      <td class='description'><textarea class="" type="text" id="descriptionInput" placeholder="A description of the acronymn"></textarea></td>
      <td class='control'><input type='submit' id='add' value='add'></td>
    </tr>
  </tfoot>

  </table>

<script>
  var database = new Firebase("https://uk-times-acronyms.firebaseio.com/");
  var records = d3.map(); // We keep a local copy of everything
  var ids_to_display = [];

  // For searching
  var index = lunr(function () {
    this.field('acronym', {boost: 10})
    this.field('alias', {boost: 5})
    this.field('description')
    this.ref('key')
  })

  var update = function() {
    var r, new_record, new_controls;

    r = d3.select("#acronyms tbody").selectAll('tr.record').data(records.values(), function(d) { return d.key; });

    // Adding records
    new_record = r.enter().append('tr')
      .attr('id', function(d) { return d.key; })
      .attr('class', 'record');

    new_record.append('td').attr('class', 'acronym')
    new_record.append('td').attr('class', 'alias')
    new_record.append('td').attr('class', 'description')
    new_controls = new_record.append('td').attr('class', 'control');
    new_controls.append('input').attr({id: 'edit', type: 'submit', value: 'edit'}).on('click', function(d) { edit(d); });
    new_controls.append('input').attr({id: 'delete', type: 'submit', value: 'delete'}).on('click', function(d) { maybe_delete(d); });

    // Updating records
    r.select('.acronym').text(function(d) { return d.acronym; });
    r.select('.alias').text(function(d) { return d.alias; });
    r.select('.description').text(function(d) { return d.description; });

    // Removing records
    r.exit().remove()

  };
  
  var maybe_delete = function(d) {
    var record = d3.select("tr.record#"+d.key);
    record.select('input#delete').attr('value', 'Click again if you are sure you want to delete').on('click', function(d) {  database.child(d.key).remove(); });
  }

  var edit = function(d) {
    var record = d3.select("tr.record#"+d.key);
    record.select('.control input#edit').attr('value', 'save').on('click', function(d) { save(d) });

    record.select('td.acronym').text("");
    record.select('td.acronym').append('input').attr({type:'text', value: d.acronym});

    record.select('td.alias').text("");
    record.select('td.alias').append('input').attr({type:'text', value: d.alias});

    record.select('td.description').text("");
    record.select('td.description').append('textarea').attr({type:'text'}).text(function(d) { return d.description; });
  }

  var save = function(d) {
    var record = d3.select("tr.record#"+d.key);

    // Get the updated data
    d.acronym = record.select('td.acronym input').node().value;
    d.alias = record.select('td.alias input').node().value;
    d.description = record.select('td.description textarea').node().value;

    // Save it
    database.child(d.key).update(d);

    // Reset everything
    record.select('.control input#edit').attr('value', 'edit').on('click', function(d) { edit(d) });
    record.selectAll('td.acronym input, td.alias input, td.description textarea').remove();
  }

  d3.select('#add').on('click', function() {
    var acronym = d3.select('#acronymInput').node().value;
    var alias = d3.select('#aliasInput').node().value;
    var description = d3.select('#descriptionInput').node().value;
    var record = {acronym: acronym, alias: alias, description: description};
    database.push(record);
    d3.select('#acronymInput').node().value = "";
    d3.select('#aliasInput').node().value = "";
    d3.select('#descriptionInput').node().value = "";
    d3.event.preventDefault();
  });

  database.on("child_added", function(snapshot) {
    var record = snapshot.val();
    record.key = snapshot.key();
    records.set(record.key, record);
    index.add(record);
    update();
  });

  database.on("child_changed", function(snapshot) {
    var record = snapshot.val();
    record.key = snapshot.key();
    records.set(record.key, record);
    index.update(record);
    update();
  });

  database.on("child_removed", function(snapshot) {
    index.remove(records.get(snapshot.key()));
    records.remove(snapshot.key());
    update();
  });


  function authDataCallback(authData) {
    if (authData) {
      d3.select("body").classed('signedout', false);
      d3.select("body").classed('signedin', true);
    } else {
      d3.select("body").classed('signedout', true);
      d3.select("body").classed('signedin', false);
    }
  }
  database.onAuth(authDataCallback);

  d3.select("#signin").on('click', function() { 
      database.authWithOAuthRedirect("github", function(error) { console.log(error); });
      d3.event.preventDefault();
      });

  d3.select("#signout").on('click', function() { database.unauth() });

  d3.select("#filter").on('keyup', function() { 
      var term = d3.select("#filter").node().value;
      if(term.length < 3) {
        d3.select("body").classed('filter', false);
        d3.selectAll(".record.show").classed('show', false);
      } else {
        d3.select("body").classed('filter', true);
        d3.selectAll(".record.show").classed('show', false);
        index.search(term).forEach(function(result) {
          d3.select("#"+result.ref).classed('show', true);
        });
      }
  });

  d3.select('#showall').on('click', function() {  
    d3.select("body").classed('filter', false);
    d3.selectAll(".record.show").classed('show', false);
    d3.select("#filter").node().value = "";
    d3.event.preventDefault();
  });
</script>

  </body>
</html>
